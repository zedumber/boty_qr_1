# ğŸ”„ DIAGRAMAS DE FLUJOS - Arquitectura Escalable

## 1ï¸âƒ£ FLUJO DE GENERACIÃ“N DE QR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BAILEYS WebSocket (WhatsApp)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  connection.update {qr}  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  handleQrCode()          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚             â”‚
         â–¼             â–¼             â–¼
    Â¿QR nuevo?   Â¿Throttle ok?  Â¿No en vuelo?
    (cache)      (30s pasÃ³)     (no duplicado)
         â”‚             â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                   YES â–¼ NO (log y salir)
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ cacheManager.setQr(sid, qr)     â”‚  â† Guardar en Redis
         â”‚ cacheManager.setStatus(sid)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ batchQueueManager.addQr()      â”‚  â† Agregar a batch
         â”‚ batchQueueManager.addStatus()  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ QR en Map de batch:          â”‚
         â”‚ qrBatch.set(sid, {qr, time}) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         Â¿Batch completo? (50 items)
           â”‚         â”‚
          YES        NO
           â”‚         â”‚
           â–¼         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    flushQrBatch()                 â”‚
           â”‚                       â”‚
           â–¼                       â”‚
    POST /qr/batch                 â”‚
    [50 QR codes]                  â”‚
           â”‚                       â”‚
           â–¼                       â”‚
    LARAVEL                        â”‚
    updateQr()                     â”‚
           â”‚                       â”‚
           â–¼                       â”‚
    âœ… Actualizado               Esperar 5s...
                                  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚
                                     O bien, cada 5 segundos:
                                     â”‚
                                     â–¼
                                flushQrBatch()
                                     â”‚
                                     â–¼
                                POST /qr/batch
                                     â”‚
                                     â–¼
                                âœ… Enviado
```

### ComparaciÃ³n:

- **ANTES:** 50 QR = 50 POST requests
- **DESPUÃ‰S:** 50 QR = 1 POST request âœ…

---

## 2ï¸âƒ£ FLUJO DE ACTUALIZACIÃ“N DE ESTADO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BAILEYS WebSocket Connection Update             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - connection: "open" (conectado)                â”‚
â”‚  - connection: "close" (desconectado)            â”‚
â”‚  - connection: "connecting" (reconectando)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚
    "open"            "close"
         â”‚                â”‚
         â–¼                â–¼
    handleSessionOpen  handleSessionClose
         â”‚                â”‚
         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ â”‚              â”‚
         â–¼ â–¼              â–¼
    Â¿loggedOut?    Verificar Laravel
         â”‚              â”‚
         NO            YES
         â”‚              â”‚
         â”‚         Reintento
         â”‚         conexiÃ³n
         â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ cacheManager.setStatus()    â”‚  â† Actualizar cache
       â”‚ cacheManager.setConnection()â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ batchQueueManager.addStatus()   â”‚
       â”‚ (priority: "high")              â”‚  â† HIGH = envÃ­o inmediato
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
    priority:                priority:
    "high"                  "normal"
        â”‚                       â”‚
    Â¿En los prÃ³ximos        Esperar batch
    500ms?                  1s
        â”‚                       â”‚
        â–¼                       â–¼
    POST /whatsapp/         Acumular en
    status/batch            statusBatch
    [INMEDIATO]             Map
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
             LARAVEL recibe
             updateStatus()
                    â”‚
                    â–¼
               âœ… actualizado
```

### Prioridades:

- **HIGH** (desconexiones): EnvÃ­o en 500ms
- **NORMAL** (pending): EnvÃ­o cada 1 segundo

---

## 3ï¸âƒ£ FLUJO DE VERIFICACIÃ“N DE SESIÃ“N ACTIVA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  isSessionActive(sessionId)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  sessionActiveCache       â”‚
      â”‚  (local, 30s TTL)         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          Â¿Valor en cache?
          Â¿No expirado?
              â”‚   â”‚
             YES  NO
              â”‚   â”‚
              â”‚   â–¼
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  â”‚ cacheManager.get()  â”‚  â† Redis cache
              â”‚  â”‚ (Redis, 120s TTL)   â”‚    session:{sid}:status
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚
              â”‚         Â¿Encontrado?
              â”‚         Â¿status != inactive?
              â”‚             â”‚   â”‚
              â”‚            YES  NO
              â”‚             â”‚   â”‚
              â”‚             â”‚   â–¼
              â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚             â”‚  â”‚ getQrStatus(sid)     â”‚
              â”‚             â”‚  â”‚ GET /status/{sid}    â”‚  â† Laravel
              â”‚             â”‚  â”‚ (ÃšLTIMO RECURSO)     â”‚
              â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚            â”‚
              â”‚             â”‚            â–¼
              â”‚             â”‚      Guardar en cache
              â”‚             â”‚      local y Redis
              â”‚             â”‚            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚          â”‚
                                         â–¼          â–¼
                                      return     return
                                      (cached)   (consulted)
```

### Cache Layers:

```
â”Œâ”€ LOCAL CACHE (30s)
   sessionActiveCache.get()
   â”œâ”€ MÃ¡s rÃ¡pido
   â”œâ”€ Menos overhead
   â””â”€ Expira 30s
      â”‚
      â””â”€ REDIS CACHE (120s)
         â”œâ”€ Compartido
         â”œâ”€ Persistente
         â””â”€ Expira 120s
            â”‚
            â””â”€ LARAVEL API
               â”œâ”€ MÃ¡s lento
               â”œâ”€ Hit real a BD
               â””â”€ Ãšltimo recurso

Resultado: 90% de consultas se resuelven sin tocar Laravel
```

---

## 4ï¸âƒ£ FLUJO DE BATCHING COMPLETO

```
SECUENCIA TEMPORAL:

t=0:00    â”Œâ”€ QR Session A arrives
          â”‚  â”œâ”€ addQr("A", "qr_data")
          â”‚  â””â”€ qrBatch = {"A": {qr...}}
          â”‚
t=0:01    â”œâ”€ QR Session B arrives
          â”‚  â”œâ”€ addQr("B", "qr_data")
          â”‚  â””â”€ qrBatch = {"A": {...}, "B": {...}}
          â”‚
t=0:02    â”œâ”€ QR Session C arrives
          â”‚  â”œâ”€ addQr("C", "qr_data")
          â”‚  â””â”€ qrBatch size: 3
          â”‚
...       â”œâ”€ ... (mÃ¡s QR llegan)
          â”‚
t=0:05    â”œâ”€ â° TIMER: 5 segundos pasaron
          â”‚  â”œâ”€ flushQrBatch()
          â”‚  â”œâ”€ POST /qr/batch [50 QR]
          â”‚  â”œâ”€ qrBatch.clear()
          â”‚  â””â”€ âœ… SENT
          â”‚
t=0:05.1  â”œâ”€ QR Session D arrives
          â”‚  â”œâ”€ addQr("D", "qr_data")
          â”‚  â””â”€ qrBatch = {"D": {...}}  (reinicia)
          â”‚
...       â”œâ”€ ... (mÃ¡s QR llegan)
          â”‚
t=0:10    â”œâ”€ â° TIMER: 5 segundos pasaron
          â”‚  â”œâ”€ flushQrBatch()
          â”‚  â”œâ”€ POST /qr/batch [35 QR]
          â”‚  â””â”€ âœ… SENT
          â”‚
t=0:10.5  â”œâ”€ Status "inactive" (HIGH priority)
          â”‚  â”œâ”€ addStatus("X", "inactive", "high")
          â”‚  â”œâ”€ flushStatusBatch() INMEDIATO
          â”‚  â”œâ”€ POST /whatsapp/status/batch [1]
          â”‚  â””â”€ âœ… SENT (500ms)
          â”‚
...       â””â”€ (continÃºa asÃ­ infinitamente)
```

---

## 5ï¸âƒ£ ARQUITECTURA GENERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WhatsApp (Baileys)                      â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ connection.update â†’ QR                                    â”‚
â”‚  â”œâ”€ messages.upsert â†’ Mensajes                                â”‚
â”‚  â””â”€ creds.update â†’ AutenticaciÃ³n                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      NODE.JS SERVER (index.js)         â”‚
    â”‚                                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  WhatsAppManager                 â”‚  â”‚
    â”‚  â”‚  â”œâ”€ handleQrCode()               â”‚  â”‚
    â”‚  â”‚  â”œâ”€ handleSessionOpen()          â”‚  â”‚
    â”‚  â”‚  â”œâ”€ handleSessionClose()         â”‚  â”‚
    â”‚  â”‚  â””â”€ isSessionActive() [Cached]   â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚           â”‚                             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚ â”‚ CacheManager (NUEVO)         â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ setQr()                   â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ isNewQr()                 â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ setStatus()               â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â””â”€ getMetrics()              â”‚  â”‚  â”‚
    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚ â”‚ BatchQueueManager (NUEVO)    â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ addQr()                   â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ addStatus()               â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ flushQrBatch()            â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â”œâ”€ flushStatusBatch()        â”‚  â”‚  â”‚
    â”‚  â”‚ â”‚ â””â”€ getMetrics()              â”‚  â”‚  â”‚
    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  QueueManager (ya existÃ­a)       â”‚  â”‚
    â”‚  â”‚  â”œâ”€ CircuitBreaker               â”‚  â”‚
    â”‚  â”‚  â”œâ”€ Redis connection             â”‚  â”‚
    â”‚  â”‚  â””â”€ Message queue                â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  REDIS  â”‚       â”‚  LARAVEL â”‚
    â”‚  Cache  â”‚       â”‚   API    â”‚
    â”‚         â”‚       â”‚          â”‚
    â”‚ - QR    â”‚       â”‚ POST /qr â”‚
    â”‚ - Statusâ”‚       â”‚ /batch   â”‚
    â”‚ - Conn  â”‚       â”‚          â”‚
    â”‚         â”‚       â”‚ POST     â”‚
    â”‚         â”‚       â”‚ /status  â”‚
    â”‚         â”‚       â”‚ /batch   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6ï¸âƒ£ COMPARACIÃ“N: ANTES vs DESPUÃ‰S

### ANTES (SaturaciÃ³n):

```
â”œâ”€ QR generado
â”‚  â””â”€ POST /api/qr {session_id, qr}
â”‚     â””â”€ LARAVEL (consultar BD)
â”‚        â””â”€ âœ… Response (500ms)
â”‚
â”œâ”€ QR generado
â”‚  â””â”€ POST /api/qr {session_id, qr}
â”‚     â””â”€ LARAVEL (consultar BD)
â”‚        â””â”€ âœ… Response (500ms)
â”‚
â”œâ”€ QR generado
â”‚  â””â”€ POST /api/qr {session_id, qr}
â”‚     â””â”€ LARAVEL (consultar BD)
â”‚        â””â”€ âœ… Response (500ms)
â”‚
â””â”€ ... (40,000 peticiones/minuto)

RESULTADO: Laravel abrumado âš ï¸
```

### DESPUÃ‰S (Escalable):

```
â”œâ”€ QR Session A â†’ Batch
â”œâ”€ QR Session B â†’ Batch
â”œâ”€ QR Session C â†’ Batch
â”œâ”€ ...
â”œâ”€ QR Session Z â†’ Batch
â”‚
â”œâ”€ [5 segundos despuÃ©s]
â”‚  â””â”€ POST /api/qr/batch [50 QR]
â”‚     â””â”€ LARAVEL (1 query)
â”‚        â””â”€ âœ… Response (100ms)
â”‚
â”œâ”€ QR Session AA â†’ Batch
â”œâ”€ QR Session AB â†’ Batch
â”œâ”€ ...
â”‚
â””â”€ [5 segundos despuÃ©s]
   â””â”€ POST /api/qr/batch [35 QR]
      â””â”€ LARAVEL (1 query)
         â””â”€ âœ… Response (100ms)

RESULTADO: Laravel relajado âœ…
```

---

## ğŸ“Š MÃ‰TRICAS DE RENDIMIENTO

```
ESCENARIO: 1000 usuarios activos

MÃ‰TRICA                 ANTES           DESPUÃ‰S         MEJORA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
QR/minuto               2,000           200            90% â†“
Peticiones/seg          666             70             90% â†“
Latencia prom.          500ms           50ms           10x â†‘
CPU Node                80%             15%            83% â†“
Memoria Node            800MB           200MB          75% â†“
BD Queries              2,000/min       200/min        90% â†“
Ancho banda             100MB           10MB           90% â†“
```

---

Este es el flujo completo de tu nueva arquitectura escalable! ğŸš€
